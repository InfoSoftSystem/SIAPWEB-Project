<?xml version='1.0' encoding='iso-8859-1' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <h:head>
        <script type="text/javascript">

            function setaModulo() {
                document.getElementById("frmPrincipal:tblMetas").click();
            }
        </script>

    </h:head>
    <ui:composition template="#{request.contextPath}/../resources/template/tareasTemplate.xhtml">
        <ui:define name="content">
            <h:form id="frmPrincipal">
                <p:menubar>
                    <p:menuitem value="Nuevo" icon="nuevo" ajax="true" action="#{planGlobalBean.nuevo}" />
                    <p:menuitem value="Modificar" icon="modificar" />
                    <p:menuitem value="Eliminar" icon="eliminar" action="#{planGlobalBean.eliminar}" update="tblMetas"/>
                    <p:menuitem value="Guardar" icon="guardar" ajax="true" action="#{planGlobalBean.guardar}" update="tblMetas tblActividades dlgRecurso"/>
                    <p:menuitem value="Recuperar" icon="recuperar" />
                    <p:menuitem value="Imprimir" icon="imprimir" />
                    <f:facet name="options">
                        <p:outputLabel value="Usuario: "/>
                        <p:outputLabel value="ADMIN" style="font-weight: bold;"/>
                        <p:spacer width="10" height="8"/>
                        <p:commandButton value="Salir" icon="salir" />
                    </f:facet>
                </p:menubar>

                <div class="dvProceso">
                    <div style=" position: absolute; border: 1px solid #ccc; border-radius: 10px; top: 100px; left: 100px;">
                        <p:spacer width="20" height="20"/>
                    </div>
                    <div style="position: absolute; border: 1px solid #ccc; left: 110px; height: 28px; top: 121px;"/>
                    <div class="dvPaso" style=" position: absolute; border: 1px solid #ccc; border-radius: 10px; top: 150px; left: 45px; width: 140px; height: 24px; text-align: center; padding-top: 6px;" onclick="visiblePgMeta();">
                        <p:outputLabel value="1. Digitación Plan Global" />
                    </div>
                    <div style="position: absolute; border: 1px solid #ccc; left: 186px; width: 62px; top: 165px;"/>
                    <div class="dvPaso" style=" position: absolute; border: 1px solid #ccc; border-radius: 10px; top: 145px; left: 250px; width: 150px; height: 50px; text-align: center; padding-top: 6px; ">
                        <p:outputLabel value="2. Verificación y generación de los PAP individuales" />
                    </div>
                    <div style="position: absolute; border: 1px solid #ccc; left: 401px; width: 62px; top: 165px;" />
                    <div class="dvPaso" style=" position: absolute; border: 1px solid #ccc; border-radius: 10px; top: 150px; left: 464px; width: 150px; height: 35px; text-align: center; padding-top: 6px; ">
                        <p:outputLabel value="3. Edición de PAP individuales" />
                    </div>
                    <div style="position: absolute; border: 1px solid #ccc; left: 616px; width: 62px; top: 165px;" />
                    <div style=" position: absolute; border: 1px solid #ccc; border-radius: 10px; top: 155px; left: 680px;">
                        <p:spacer width="20" height="20"/>
                    </div>
                </div>

                <p:remoteCommand name="visiblePgMeta" oncomplete="dlgMeta.show();">  
                    <f:setPropertyActionListener value="#{true}" target="#{planGlobalBean.showMeta}" />  
                </p:remoteCommand> 

                <p:dialog id="dlgMeta" widgetVar="dlgMeta" header="1. Digitacion del Plan Global" visible="#{planGlobalBean.showMeta}" width="630" 
                          resizable="false">
                    <p:ajax event="close" listener="#{planGlobalBean.cerrarPopupMeta}"/>  

                    <h:panelGrid columns="2">
                        <p:outputLabel value="1. Origen de los recursos:"/>
                        <p:selectOneMenu id="cbOrigenRe" value="#{planGlobalBean.idOrigen}">
                            <f:selectItem itemLabel="Seleccione un valor"/>
                            <f:selectItems value="#{planGlobalBean.lstOrigenRecursos}" var="origen" itemValue="#{origen.idOrigenRecursos}" itemLabel="#{origen.descripcionDeLosRecursos}"/>
                            <p:ajax update="cbProyecto"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="2. Proyecto/Convenio:"/>
                        <p:selectOneMenu id="cbProyecto" value="#{planGlobalBean.idConvenio}">
                            <f:selectItem itemLabel="Seleccione un valor"/>
                            <f:selectItems value="#{planGlobalBean.lstConvenios}" var="selectConvenio" itemValue="#{selectConvenio.convenio}" itemLabel="#{selectConvenio.numeroConvenio}"/>
                            <p:ajax update=":frmPrincipal:dlgMeta" listener="#{planGlobalBean.armarTreeComponentes}" />
                        </p:selectOneMenu>

                        <p:outputLabel value="3. Estado:"/>
                        <p:selectOneMenu id="cbEstado">
                            <f:selectItem itemLabel="Seleccione un valor"/>
                            <f:selectItems value="#{planGlobalBean.lstEstadoEjecConvenio}"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="4. Plantilla de configuración"/>
                        <p:inputTextarea id="txtPlantilla" readonly="trye" value="#{planGlobalBean.detCompPlanilla.descripcionDeLaPlantilla}" cols="80" rows="3"/>
                    </h:panelGrid>

                    <h:panelGrid columns="1">
                        <p:outputLabel value="5. Seleccione el componente/sub-componente:" rendered="#{planGlobalBean.visibleComponentes}"/>
                        <p:tree id="trComponentes" style="width: 600px; height: 100px;" value="#{planGlobalBean.nodoComponentes}" var="comp" cache="false" selectionMode="single" rendered="#{planGlobalBean.visibleComponentes}">
                            <p:ajax event="select" update=":frmPrincipal:tblMetas :frmPrincipal:lblComponente" listener="#{planGlobalBean.onNodeSelect}" />  

                            <p:treeNode id="treeNode">  
                                <h:outputText value="#{comp}" id="lblNode"/>  
                            </p:treeNode>  
                        </p:tree>

                        <p:outputLabel id="lblComponente" value="5. Sub-componente seleccionado: #{planGlobalBean.nombreComponente}" rendered="#{planGlobalBean.visibleComponentes}"/>
                        <p:dataTable id="tblMetas" value="#{planGlobalBean.lstMetas}" var="meta" editMode="cell" rowIndexVar="rowId"
                                     editable="true" rowKey="#{meta.meta}" widgetVar="tblMetas"  style="width: 600px !important;" 
                                     paginator="true" rows="3" paginatorPosition="top" rendered="#{planGlobalBean.visibleMetas}">

                            <p:ajax event="cellEdit" listener="#{planGlobalBean.onCellEditMeta}" update="tblMetas"/>
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column rowspan="2" headerText="Id"/>
                                    <p:column rowspan="2" headerText="Código"/>
                                    <p:column rowspan="2" headerText="Meta"/>
                                    <p:column colspan="#{planGlobalBean.numColSpanFuentes}" headerText="A. Monto asignado"/>
                                    <p:column rowspan="2" headerText="Tipo Meta"/>
                                    <p:column rowspan="2" headerText=""/>
                                </p:row>

                                <p:row>
                                    <p:column headerText="#{planGlobalBean.nombreFtePpal}" rendered="#{planGlobalBean.contrapartida}"/>
                                    <p:column headerText="#{planGlobalBean.nombreFteCont}" rendered="#{planGlobalBean.contrapartida}"/>
                                    <p:column headerText="Total"/>
                                </p:row>
                            </p:columnGroup>

                            <p:column headerText="Id" >
                                <h:outputText value="#{meta.meta}"/>
                            </p:column>

                            <p:column headerText="Código" style="width: 50px; text-align: right;">
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <h:outputText value="#{meta.codigoMeta}"/>
                                    </f:facet>
                                    <f:facet name="input">  
                                        <p:inputText value="#{meta.codigoMeta}" size="8" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Meta" footerText="Sub-total" styleClass="wrap" style="width: 150px !important; ">
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <h:outputText value="#{meta.metaNombre}" />  
                                    </f:facet>  
                                    <f:facet name="input">  
                                        <p:inputTextarea value="#{meta.metaNombre}" style="width:90%"/>  
                                    </f:facet>  
                                </p:cellEditor>
                            </p:column>

                            <p:column rendered="#{planGlobalBean.contrapartida}" styleClass="numero">
                                <h:outputText value="#{meta.montoBanco}">
                                    <f:convertNumber pattern="#,##0.00" />
                                </h:outputText>

                                <f:facet name="footer">  
                                    <h:outputText value="#{planGlobalBean.totalMontoBancoMeta}" id="totalBanco">
                                        <f:convertNumber pattern="#,##0.00"  />
                                    </h:outputText>
                                </f:facet> 
                            </p:column>

                            <p:column rendered="#{planGlobalBean.contrapartida}" styleClass="numero">
                                <h:outputText value="#{meta.montoGoes}">
                                    <f:convertNumber pattern="#,##0.00"  />
                                </h:outputText>

                                <f:facet name="footer">  
                                    <h:outputText value="#{planGlobalBean.totalMontoGoesMeta}" id="totalGoes">
                                        <f:convertNumber pattern="#,##0.00"  />
                                    </h:outputText>
                                </f:facet> 
                            </p:column>

                            <p:column style="width: 90px; text-align: right;">
                                <h:outputText value="#{meta.montoBanco+meta.montoGoes}" id="totalMeta">
                                    <f:convertNumber pattern="#,##0.00"  />
                                </h:outputText>

                                <f:facet name="footer">  
                                    <h:outputText value="#{planGlobalBean.totalMeta}" id="total">
                                        <f:convertNumber pattern="#,##0.00"  />
                                    </h:outputText>
                                </f:facet> 
                            </p:column>

                            <p:column>
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <p:outputLabel id="cbTipoMeta" value="#{meta.desTipoDeMeta}" />
                                    </f:facet>

                                    <f:facet name="input">  
                                        <p:selectOneMenu value="#{meta.tipoDeMetas}" style="width: 100px;">
                                            <f:selectItems value="#{planGlobalBean.lstTipoMeta}" />
                                        </p:selectOneMenu>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column >
                                <p:commandLink actionListener="#{planGlobalBean.newActividad}" >
                                    <f:attribute name="meta" value="#{meta}"/>
                                    <p:graphicImage url="#{request.contextPath}/../resources/images/add.png"/>
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                        <p:commandButton value="Agregar Actividades" action="#{planGlobalBean.newActividad}" rendered="#{planGlobalBean.visibleBtnActividades}" />
                    </h:panelGrid>
                </p:dialog>

                <p:dialog id="dlgActividad" widgetVar="dlgActividad" header="1.1. Ingreso de actividades" visible="#{planGlobalBean.showActividad}"
                          resizable="false" width="675" closable="true">
                    <p:ajax event="close" listener="#{planGlobalBean.cerrarPopupActividad}"/>  

                    <h:panelGrid columns="1">
                        <p:outputLabel value="1. Meta seleccionada:" rendered="#{planGlobalBean.visibleMetas}"/>
                        <p:outputLabel value="#{planGlobalBean.pgMeta.metaNombre}" style="font-weight: bold;" rendered="#{planGlobalBean.visibleMetas}"/>
                        <p:outputLabel value="2. Ingrese las actividades relacionadas:"/>

                        <p:dataTable id="tblActividades" value="#{planGlobalBean.lstActividades}" var="act" editMode="cell" editable="true"
                                     widgetVar="tblActividades"  rowIndexVar="rowId" rowKey="#{act.actividad}"  style="width: 650px !important;" 
                                     paginator="true" rows="3" paginatorPosition="top" selection="#{planGlobalBean.pgActividad}">

                            <p:ajax event="cellEdit" listener="#{planGlobalBean.onCellEditActividad}" update="tblActividades"/>
                            <p:columnGroup type="header">
                                <p:row>
                                    <p:column rowspan="2" headerText="Id"/>
                                    <p:column rowspan="2" headerText="Código"/>
                                    <p:column rowspan="2" headerText="Actividades"/>
                                    <p:column colspan="#{planGlobalBean.numColSpanFuentes}" headerText="A. Monto asignado"/>
                                    <p:column colspan="3" headerText="B. Ejecución prevista"/>
                                    <p:column rowspan="2" headerText=""/>
                                </p:row>

                                <p:row>
                                    <p:column headerText="#{planGlobalBean.nombreFtePpal}" rendered="#{planGlobalBean.contrapartida}"/>
                                    <p:column headerText="#{planGlobalBean.nombreFteCont}" rendered="#{planGlobalBean.contrapartida}"/>
                                    <p:column headerText="Total"/>
                                    <p:column headerText="Año PAP"/>
                                    <p:column headerText="Inicio"/>
                                    <p:column headerText="Fin"/>
                                </p:row>
                            </p:columnGroup>

                            <p:column headerText="Id">
                                <p:outputLabel value="#{act.actividad}" />
                            </p:column>

                            <p:column headerText="Código">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="#{act.codigoActividad}" />
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText value="#{act.codigoActividad}" size="8" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Actividades" footerText="Sub-total" styleClass="wrap" style="width: 150px !important; ">
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <h:outputText value="#{act.actividadNombre}" />  
                                    </f:facet>  
                                    <f:facet name="input">  
                                        <p:inputTextarea value="#{act.actividadNombre}" style="width:90%"/>  
                                    </f:facet>  
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Fte. Ppal." rendered="#{planGlobalBean.contrapartida}" styleClass="numero">
                                <h:outputText value="#{act.financiamientoBanco}" >
                                    <f:convertNumber pattern="#,##0.00"/>
                                </h:outputText>

                                <f:facet name="footer">  
                                    <h:outputText value="#{planGlobalBean.totalMontoBancoActividad}" id="totalBanco">
                                        <f:convertNumber pattern="#,##0.00"  />
                                    </h:outputText>
                                </f:facet> 
                            </p:column>

                            <p:column headerText="Contrapartida" rendered="#{planGlobalBean.contrapartida}" styleClass="numero">
                                <h:outputText value="#{act.financiamientoGoes}">
                                    <f:convertNumber pattern="#,##0.00"/>
                                </h:outputText>

                                <f:facet name="footer">  
                                    <h:outputText value="#{planGlobalBean.totalMontoGoesActividad}" id="totalGoes">
                                        <f:convertNumber pattern="#,##0.00"  />
                                    </h:outputText>
                                </f:facet> 
                            </p:column>

                            <p:column headerText="Total">
                                <h:outputText value="#{act.financiamientoBanco+actividad.financiamientoGoes}" id="totalActividad">
                                    <f:convertNumber pattern="#,##0.00"  />
                                </h:outputText>

                                <f:facet name="footer">  
                                    <h:outputText value="#{planGlobalBean.totalActividad}" id="total">
                                        <f:convertNumber pattern="$ #,##0.00"  />
                                    </h:outputText>
                                </f:facet> 
                            </p:column>

                            <p:column headerText="Año PAP" rendered="#{planGlobalBean.visibleAnhoPap}" >
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <p:outputLabel value="#{act.anhoPg}" />
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:selectOneMenu value="#{act.pgAnosPlanGlobal}" style="width: 100px;" >
                                            <f:selectItems value="#{planGlobalBean.lstAnhosPg}"/>
                                        </p:selectOneMenu>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Inicio" >
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="#{act.actividadInicioPrevisto}" >
                                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                                        </h:outputText>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:calendar value="#{act.actividadInicioPrevisto}" pattern="dd/MM/yyyy" size="9"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Fin" >
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="#{act.actividadFinPrevisto}" >
                                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                                        </h:outputText>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:calendar value="#{act.actividadFinPrevisto}" pattern="dd/MM/yyyy" size="9"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column >
                                <p:commandLink action="#{planGlobalBean.newRecurso}" >
                                    <f:setPropertyActionListener value="#{act}" target="#{planGlobalBean.pgActividad}" />  
                                    <p:graphicImage url="#{request.contextPath}/../resources/images/add.png"/>
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                    </h:panelGrid>
                </p:dialog>

                <p:dialog id="dlgRecurso" widgetVar="dlgRecurso" header="1.2. Ingreso de Recursos" visible="#{planGlobalBean.showRecurso}" width="700">
                    <p:ajax event="close" listener="#{planGlobalBean.cerrarPopupRecurso}"/>  

                    <h:panelGrid columns="2">
                        <p:outputLabel value="Meta:" rendered="#{planGlobalBean.visibleMetas}"/>
                        <p:outputLabel value="#{planGlobalBean.pgMeta.meta} - #{planGlobalBean.pgMeta.metaNombre}" style="font-weight: bold;" rendered="#{planGlobalBean.visibleMetas}"/>
                        <p:outputLabel value="Actividad:" rendered="#{planGlobalBean.visibleActividades}"/>
                        <p:outputLabel value="#{planGlobalBean.pgActividad.actividad} - #{planGlobalBean.pgActividad.actividadNombre}" style="font-weight: bold;" rendered="#{planGlobalBean.visibleActividades}"/>
                        <p:outputLabel value="1. Categoria/Sub-categoria:"/>
                        <p:selectOneMenu id="cbCategoria" value="#{planGlobalBean.currentRecurso.idCategoria}" disabled="#{planGlobalBean.deshabilitarRecurso}">
                            <f:selectItem itemLabel="Seleccione un valor"/>
                            <f:selectItems value="#{planGlobalBean.lstPgCategorias}" var="categoria" itemValue="#{categoria.idCategoria}" itemLabel="#{categoria.descripcion}"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="2. Producto:"/>
                        <p:selectOneMenu id="cbProducto" value="#{planGlobalBean.currentRecurso.producto}" disabled="#{planGlobalBean.deshabilitarRecurso}">
                            <f:selectItem itemLabel="Seleccione un valor"/>
                            <f:selectItems value="#{planGlobalBean.lstCatalogoProductos}" var="producto" itemValue="#{producto.producto}" itemLabel="#{producto.descripcion}"/>
                            <p:ajax update="txtClasificador" listener="#{planGlobalBean.cargarClasificador}"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="3. Cantidad:"/>
                        <h:panelGrid columns="5">
                            <p:inputText id="txtCantidad" size="10" value="#{planGlobalBean.currentRecurso.cantidad}" style="text-align: right" disabled="#{planGlobalBean.deshabilitarRecurso}"/>
                            <p:spacer width="16" height="8"/>
                            <p:outputLabel value="#{planGlobalBean.nombreFtePpal}"/>
                            <p:spacer width="30" height="8"/>
                            <p:outputLabel value="#{planGlobalBean.nombreFteCont}"/>
                        </h:panelGrid>

                        <p:outputLabel value="4. Valor total:"/>
                        <h:panelGrid columns="5">
                            <p:inputText id="txtValor" size="10" value="#{planGlobalBean.currentRecurso.valor}" style="text-align: right" disabled="#{planGlobalBean.deshabilitarRecurso}"/>
                            <p:spacer width="10" height="8"/>
                            <p:inputText id="txtValorFtePpal" label="Keyword" rendered="#{planGlobalBean.contrapartida}" size="10"  style="text-align: right" value="#{planGlobalBean.recursoFtePpal.montoPreliminar}" disabled="#{planGlobalBean.deshabilitarRecurso}"/>
                            <p:spacer width="10" height="8"/>
                            <p:inputText id="txtContrapartida" label="Keyword" rendered="#{planGlobalBean.contrapartida}" size="10" style="text-align: right" value="#{planGlobalBean.recursoFteCont.montoPreliminar}" disabled="#{planGlobalBean.deshabilitarRecurso}"/>
                        </h:panelGrid>

                        <p:outputLabel value="5. Clasificador Presupuestario:"/>
                        <p:inputText id="txtClasificador" value="#{planGlobalBean.clasificadorPresupuestario}" disabled="#{planGlobalBean.deshabilitarRecurso}" readonly="true"/>
                        <p:outputLabel value="6. Observaciones:"/>
                        <p:inputTextarea id="txaObservaciones" cols="75" disabled="#{planGlobalBean.deshabilitarRecurso}" value="#{planGlobalBean.currentRecurso.observacion}"/>

                        <p:outputLabel value="7. Tipo de ejecución:"/>
                        <p:selectOneMenu id="cbTipoEjecucion" value="#{planGlobalBean.currentRecurso.trasferencia}" disabled="#{planGlobalBean.deshabilitarRecurso}">
                            <f:selectItem itemLabel="Seleccione un valor"/>
                            <f:selectItems value="#{planGlobalBean.lstTipoRecurso}" var="tipoRecurso" itemValue="#{tipoRecurso.trasferencia}" itemLabel="#{tipoRecurso.descripcionTipoRecurso}"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="8. Fecha adquisición prevista:"/>
                        <p:calendar id="cdlAdquisicion" pattern="dd/MM/yyyy" size="10" value="#{planGlobalBean.currentRecurso.fechaAdquisicion}" disabled="#{planGlobalBean.deshabilitarRecurso}"/>
                    </h:panelGrid>

                    <p:outputLabel value="9. Listado de Recursos"/>
                    <p:dataTable id="tblRecursos" value="#{planGlobalBean.lstRecuros}" var="recurso" paginator="true" rows="5"
                                 editable="true" editMode="cell" rowIndexVar="rowId" widgetVar="tblRecursos" 
                                 selection="#{planGlobalBean.currentRecurso}" rowKey="#{recurso.recurso}">

                        <p:column headerText="Recurso">
                            <p:outputLabel value="#{recurso.recurso}"/>
                        </p:column>

                        <p:column headerText="Descripción">
                            <p:outputLabel value="#{recurso.observacion}"/>
                        </p:column>

                        <p:column headerText="Valor">
                            <h:outputText value="#{recurso.valor}">
                                <f:convertNumber pattern="$ #,##0.00" />
                            </h:outputText>
                        </p:column> 

                        <p:column >
                            <p:commandLink action="#{planGlobalBean.selectRecurso}" >
                                <f:setPropertyActionListener value="#{recurso}" target="#{planGlobalBean.currentRecurso}" />  
                                <p:graphicImage url="#{request.contextPath}/../resources/images/add.png"/>
                            </p:commandLink>
                        </p:column>
                    </p:dataTable>
                </p:dialog>
            </h:form>
        </ui:define>
    </ui:composition>
</html>